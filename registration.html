<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Registration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .registration-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .registration-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .registration-header h2 {
            color: #343a40;
        }
        .btn-register {
            background-color: #28a745;
            border: none;
            width: 100%;
            padding: 12px;
            font-weight: 600;
        }
        .btn-register:hover {
            background-color: #218838;
        }
        .form-label {
            font-weight: 600;
        }
        .login-link {
            text-align: center;
            margin-top: 20px;
        }
        #loadingSpinner {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="registration-container">
            <div class="registration-header">
                <h2>Student Registration</h2>
                <p>Create your account to save your information</p>
            </div>
            <form id="registrationForm">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="regNIC" class="form-label">NIC Number*</label>
                        <input type="text" class="form-control" id="regNIC" required>
                        <div class="form-text">Your National Identity Card Number</div>
                    </div>
                    <div class="col-md-6">
                        <label for="regName" class="form-label">Full Name*</label>
                        <input type="text" class="form-control" id="regName" required>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="regDistrict" class="form-label">District*</label>
                        <select class="form-select" id="regDistrict" required>
                            <option value="">Select District</option>
                            <option value="Ampara">Ampara</option>
                            <option value="Anuradhapura">Anuradhapura</option>
                            <!-- All other districts -->
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="regClass" class="form-label">Class*</label>
                        <select class="form-select" id="regClass" required>
                            <option value="">Select Class</option>
                            <option value="Grade 10">Grade 10</option>
                            <option value="Grade 11">Grade 11</option>
                            <option value="AL Year 1">A/L Year 1</option>
                            <option value="AL Year 2">A/L Year 2</option>
                            <option value="Revision">Revision Class</option>
                        </select>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="regSchool" class="form-label">School</label>
                        <input type="text" class="form-control" id="regSchool">
                    </div>
                    <div class="col-md-6">
                        <label for="regPhone" class="form-label">Phone Number*</label>
                        <input type="tel" class="form-control" id="regPhone" required>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="regEmail" class="form-label">Email Address*</label>
                        <input type="email" class="form-control" id="regEmail" required>
                    </div>
                    <div class="col-md-6">
                        <label for="regPassword" class="form-label">Password*</label>
                        <input type="password" class="form-control" id="regPassword" required>
                        <div class="form-text">Minimum 6 characters</div>
                    </div>
                </div>

                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="regTerms" required>
                    <label class="form-check-label" for="regTerms">I agree to the terms and conditions</label>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-register" id="registerBtn">
                        <span id="registerText">Register</span>
                        <div id="loadingSpinner" class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </button>
                </div>

                <div class="login-link">
                    Already have an account? <a href="login.html">Login here</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase configuration (replace with your actual config)
        const firebaseConfig = {
    apiKey: "AIzaSyD5SRZWB-QwMg7wmyTjcvHZqP-mEdlll_M",
    authDomain: "paper-class-1ab19.firebaseapp.com",
    databaseURL: "https://paper-class-1ab19-default-rtdb.firebaseio.com",
    projectId: "paper-class-1ab19",
    storageBucket: "paper-class-1ab19.firebasestorage.app",
    messagingSenderId: "83634677566",
    appId: "1:83634677566:web:fb4f7a1fd869c3e82e2e6f"
  };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Handle registration
        document.getElementById('registrationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show loading state
            document.getElementById('registerText').style.display = 'none';
            document.getElementById('loadingSpinner').style.display = 'inline-block';
            document.getElementById('registerBtn').disabled = true;
            
            const nic = document.getElementById('regNIC').value.trim();
            const name = document.getElementById('regName').value.trim();
            const district = document.getElementById('regDistrict').value;
            const studentClass = document.getElementById('regClass').value;
            const school = document.getElementById('regSchool').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            
            // Validate NIC format (Sri Lankan NIC)
            if (!/^([0-9]{9}[xXvV]|[0-9]{12})$/.test(nic)) {
                showError('Please enter a valid NIC number (old format: 123456789V, new format: 123456789012)');
                return;
            }
            
            // Validate phone number
            if (!/^[0-9]{10}$/.test(phone)) {
                showError('Please enter a valid 10-digit phone number');
                return;
            }
            
            // First check if NIC already exists
            database.ref('users/' + nic).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        throw new Error('This NIC is already registered');
                    }
                    
                    // Create user with email/password
                    return auth.createUserWithEmailAndPassword(email, password);
                })
                .then((userCredential) => {
                    // Save user data to database
                    const userData = {
                        nic,
                        name,
                        district,
                        class: studentClass,
                        school,
                        phone,
                        email,
                        registered: true,
                        registeredAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    return database.ref('users/' + nic).set(userData);
                })
                .then(() => {
                    // Save NIC to localStorage for auto-fill
                    localStorage.setItem('userNIC', nic);
                    
                    alert('Registration successful! You can now login.');
                    window.location.href = 'login.html';
                })
                .catch((error) => {
                    console.error('Registration error:', error);
                    showError(getErrorMessage(error));
                });

            function showError(message) {
                // Hide loading state
                document.getElementById('registerText').style.display = 'inline';
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('registerBtn').disabled = false;
                
                alert(message);
            }

            function getErrorMessage(error) {
                let errorMessage = 'Registration failed. ';
                if (error.message.includes('NIC is already registered')) {
                    return error.message;
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage += 'Email is already in use.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage += 'Password should be at least 6 characters.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage += 'Invalid email address.';
                } else {
                    errorMessage += error.message;
                }
                return errorMessage;
            }
        });

        // Removed the automatic redirect on auth state change
        // This was causing the immediate redirect to dashboard
    </script>
    <script src="main.js"></script>
</body>
</html>