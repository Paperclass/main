<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paper Class Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --accent: #4895ef;
      --light: #f8f9fa;
      --dark: #212529;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
    }
    
    .navbar-brand {
      font-weight: 700;
      font-size: 1.5rem;
    }
    
    .card {
      border-radius: 12px;
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      font-weight: 600;
      padding: 1rem 1.25rem;
    }
    
    .badge-district {
      font-size: 0.75rem;
      padding: 0.35em 0.65em;
      border-radius: 50px;
    }
    
    .nugegoda-badge { background-color: #4cc9f0; color: white; }
    .kandy-badge { background-color: #7209b7; color: white; }
    .kurunegala-badge { background-color: #f72585; color: white; }
    .online-badge { background-color: #3a86ff; color: white; }
    .all-island-badge { background-color: #4895ef; color: white; }
    
    .rank-card {
      background: white;
      border-left: 4px solid var(--primary);
    }
    
    .rank-1 { border-left-color: #ffd700; }
    .rank-2 { border-left-color: #c0c0c0; }
    .rank-3 { border-left-color: #cd7f32; }
    
    .filter-section {
      background: white;
      border-radius: 10px;
      padding: 1.25rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .paper-thumbnail {
      height: 120px;
      background-color: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 2.5rem;
    }
    
    .timer {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }
    
    @media (max-width: 768px) {
      .paper-thumbnail {
        height: 80px;
        font-size: 1.5rem;
      }
      
      .card-header {
        padding: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="fas fa-book-open me-2"></i>Paper Class
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link active" href="#papers-section"><i class="fas fa-file-alt me-1"></i> Papers</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#rankings-section"><i class="fas fa-trophy me-1"></i> Rankings</a>
          </li>
          <li class="nav-item" id="authNavItem">
            <button id="loginBtn" class="btn btn-outline-light ms-lg-2 mt-2 mt-lg-0">
              <i class="fas fa-sign-in-alt me-1"></i> Login
            </button>
          </li>
          <li class="nav-item d-none" id="userNavItem">
            <div class="dropdown ms-lg-2 mt-2 mt-lg-0">
              <button class="btn btn-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                <i class="fas fa-user-circle me-1"></i> <span id="userName"></span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#"><i class="fas fa-user me-1"></i> Profile</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><button id="logoutBtn" class="dropdown-item"><i class="fas fa-sign-out-alt me-1"></i> Logout</button></li>
              </ul>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container py-4">
    <!-- Papers Section -->
    <section id="papers-section" class="mb-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><i class="fas fa-file-alt me-2"></i>Available Papers</h2>
        <button class="btn btn-sm btn-outline-primary" id="togglePaperFilters">
          <i class="fas fa-filter me-1"></i> Filters
        </button>
      </div>
      
      <div class="filter-section mb-4" id="paperFilters">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Year</label>
            <select id="paperYearFilter" class="form-select">
              <option value="all">All Years</option>
              <option value="2027" selected>2027</option>
              <option value="2026">2026</option>
              <option value="2025">2025</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Class</label>
            <select id="paperClassFilter" class="form-select">
              <option value="all">All Classes</option>
              <option value="class1">Class 1</option>
              <option value="class2">Class 2</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">District</label>
            <select id="paperDistrictFilter" class="form-select">
              <option value="all">All Island</option>
              <option value="nugegoda">Nugegoda</option>
              <option value="kandy">Kandy</option>
              <option value="kurunegala">Kurunegala</option>
              <option value="online">Online</option>
            </select>
          </div>
        </div>
      </div>
      
      <div id="papersContainer" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <!-- Papers will be loaded here -->
        <div class="col">
          <div class="card h-100">
            <div class="paper-thumbnail">
              <i class="fas fa-file-pdf"></i>
            </div>
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0">Paper 01 - Mathematics</h5>
                <span class="badge bg-primary">2027</span>
              </div>
              <p class="card-text text-muted small mb-2">Class 1 | <span class="badge nugegoda-badge">Nugegoda</span></p>
              <p class="card-text small">Available until: 2027-12-31</p>
              <div class="d-flex justify-content-between align-items-center">
                <span class="badge bg-light text-dark"><i class="fas fa-clock me-1"></i> 2 hours</span>
                <button class="btn btn-sm btn-primary">Download</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Rankings Section -->
    <section id="rankings-section" class="mb-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><i class="fas fa-trophy me-2"></i>Rankings</h2>
        <button class="btn btn-sm btn-outline-primary" id="toggleRankFilters">
          <i class="fas fa-filter me-1"></i> Filters
        </button>
      </div>
      
      <div class="filter-section mb-4" id="rankFilters">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Year</label>
            <select id="rankYearFilter" class="form-select">
              <option value="2027" selected>2027</option>
              <option value="2026">2026</option>
              <option value="2025">2025</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Class</label>
            <select id="rankClassFilter" class="form-select">
              <option value="class1">Class 1</option>
              <option value="class2">Class 2</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Paper Number</label>
            <select id="rankPaperFilter" class="form-select">
              <option value="1">Paper 01</option>
              <option value="2">Paper 02</option>
              <option value="3">Paper 03</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">District</label>
            <select id="rankDistrictFilter" class="form-select">
              <option value="all">All Island</option>
              <option value="nugegoda">Nugegoda</option>
              <option value="kandy">Kandy</option>
              <option value="kurunegala">Kurunegala</option>
              <option value="online">Online</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Personal Rank Card (visible when logged in) -->
      <div id="personalRankContainer" class="card rank-card mb-4" style="display: none;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-title mb-1">Your Rank</h5>
              <p class="card-text text-muted small mb-0" id="userPaperInfo"></p>
            </div>
            <div class="text-end">
              <h2 class="mb-0 text-primary" id="userRank"></h2>
              <p class="small mb-0"><span id="userDistrict" class="badge nugegoda-badge"></span> | <span id="userMarks"></span></p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Rankings Table -->
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <span>Top 100 Students</span>
            <div class="d-flex">
              <button class="btn btn-sm btn-outline-light me-2" id="prevRankPage" disabled>
                <i class="fas fa-chevron-left"></i>
              </button>
              <button class="btn btn-sm btn-outline-light" id="nextRankPage">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th width="80">Rank</th>
                <th>Student</th>
                <th width="120">District</th>
                <th width="120">Marks</th>
                <th width="100">Class</th>
              </tr>
            </thead>
            <tbody id="rankingsTable">
              <!-- Rankings will be loaded here -->
              <tr class="rank-1">
                <td><span class="badge bg-warning text-dark">1</span></td>
                <td>John Doe</td>
                <td><span class="badge nugegoda-badge">Nugegoda</span></td>
                <td>98%</td>
                <td>Class 1</td>
              </tr>
              <tr class="rank-2">
                <td><span class="badge bg-secondary">2</span></td>
                <td>Jane Smith</td>
                <td><span class="badge kandy-badge">Kandy</span></td>
                <td>97%</td>
                <td>Class 1</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Paper Modal -->
  <div class="modal fade" id="paperModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="paperModalTitle"></h5>
          <div class="timer" id="timerDisplay"></div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <iframe id="paperViewer" style="width: 100%; height: 70vh; border: none;"></iframe>
        </div>
        <div class="modal-footer justify-content-between">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i> Close
          </button>
          <div>
            <button id="submitPaperBtn" class="btn btn-success me-2">
              <i class="fas fa-paper-plane me-1"></i> Submit
            </button>
            <button id="downloadAnswerBtn" class="btn btn-primary" style="display: none;">
              <i class="fas fa-download me-1"></i> Answer Sheet
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase and other JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  
  <script>
    // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyD5SRZWB-QwMg7wmyTjcvHZqP-mEdlll_M",
    authDomain: "paper-class-1ab19.firebaseapp.com",
    databaseURL: "https://paper-class-1ab19-default-rtdb.firebaseio.com",
    projectId: "paper-class-1ab19",
    storageBucket: "paper-class-1ab19.firebasestorage.app",
    messagingSenderId: "83634677566",
    appId: "1:83634677566:web:fb4f7a1fd869c3e82e2e6f"
  };


    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // DOM elements
    const papersContainer = document.getElementById('papersContainer');
    const rankingsTable = document.getElementById('rankingsTable');
    const personalRankContainer = document.getElementById('personalRankContainer');
    const paperModal = new bootstrap.Modal(document.getElementById('paperModal'));
    const paperViewer = document.getElementById('paperViewer');
    const timerDisplay = document.getElementById('timerDisplay');
    const submitPaperBtn = document.getElementById('submitPaperBtn');
    const downloadAnswerBtn = document.getElementById('downloadAnswerBtn');
    const togglePaperFilters = document.getElementById('togglePaperFilters');
    const toggleRankFilters = document.getElementById('toggleRankFilters');
    const paperFilters = document.getElementById('paperFilters');
    const rankFilters = document.getElementById('rankFilters');
    
    let examTimer;
    let currentPaperId;
    let currentRankPage = 1;
    const ranksPerPage = 10;

    // Initialize UI
    document.addEventListener('DOMContentLoaded', () => {
      // Set current year in filters
      const currentYear = new Date().getFullYear();
      document.getElementById('paperYearFilter').value = currentYear;
      document.getElementById('rankYearFilter').value = currentYear;
      
      // Toggle filter sections
      togglePaperFilters.addEventListener('click', () => {
        paperFilters.classList.toggle('d-none');
        togglePaperFilters.innerHTML = paperFilters.classList.contains('d-none') ? 
          '<i class="fas fa-filter me-1"></i> Show Filters' : 
          '<i class="fas fa-filter me-1"></i> Hide Filters';
      });
      
      toggleRankFilters.addEventListener('click', () => {
        rankFilters.classList.toggle('d-none');
        toggleRankFilters.innerHTML = rankFilters.classList.contains('d-none') ? 
          '<i class="fas fa-filter me-1"></i> Show Filters' : 
          '<i class="fas fa-filter me-1"></i> Hide Filters';
      });
      
      // Initialize pagination buttons
      document.getElementById('prevRankPage').addEventListener('click', () => {
        if (currentRankPage > 1) {
          currentRankPage--;
          loadRankings();
        }
      });
      
      document.getElementById('nextRankPage').addEventListener('click', () => {
        currentRankPage++;
        loadRankings();
      });
    });

    // Auth state listener
    auth.onAuthStateChanged(user => {
      if (user) {
        // User is logged in
        document.getElementById('authNavItem').classList.add('d-none');
        document.getElementById('userNavItem').classList.remove('d-none');
        document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
        personalRankContainer.style.display = 'block';
        
        loadPersonalRank(user.uid);
        loadStudentPapers(user.uid);
      } else {
        // User is logged out
        document.getElementById('authNavItem').classList.remove('d-none');
        document.getElementById('userNavItem').classList.add('d-none');
        personalRankContainer.style.display = 'none';
        
        loadPublicPapers();
      }
      
      loadRankings();
    });

    // Auth buttons
    document.getElementById('loginBtn').addEventListener('click', () => {
      // Simple email/password login (replace with your preferred method)
      const email = prompt("Enter your email:");
      const password = prompt("Enter your password:");
      
      auth.signInWithEmailAndPassword(email, password)
        .catch(error => {
          alert(`Login failed: ${error.message}`);
        });
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      auth.signOut();
    });

    // Load papers functions
    function loadStudentPapers(uid) {
      const year = document.getElementById('paperYearFilter').value;
      const paperClass = document.getElementById('paperClassFilter').value;
      const district = document.getElementById('paperDistrictFilter').value;
      
      let ref = database.ref('student_papers').orderByChild('year');
      
      if (year !== 'all') {
        ref = ref.equalTo(year);
      }
      
      ref.once('value').then(snapshot => {
        papersContainer.innerHTML = '';
        
        snapshot.forEach(paperSnapshot => {
          const paper = paperSnapshot.val();
          
          // Apply filters
          if ((paperClass === 'all' || paper.class === paperClass) && 
              (district === 'all' || paper.district === district)) {
            createPaperCard(paper, paperSnapshot.key);
          }
        });
        
        if (papersContainer.innerHTML === '') {
          papersContainer.innerHTML = `
            <div class="col-12 text-center py-5">
              <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
              <h5>No papers found</h5>
              <p class="text-muted">Try adjusting your filters</p>
            </div>
          `;
        }
      });
    }

    function loadPublicPapers() {
      const year = document.getElementById('paperYearFilter').value;
      const paperClass = document.getElementById('paperClassFilter').value;
      const district = document.getElementById('paperDistrictFilter').value;
      
      let ref = database.ref('papers').orderByChild('year');
      
      if (year !== 'all') {
        ref = ref.equalTo(year);
      }
      
      ref.once('value').then(snapshot => {
        papersContainer.innerHTML = '';
        
        snapshot.forEach(paperSnapshot => {
          const paper = paperSnapshot.val();
          
          // Apply filters
          if ((paperClass === 'all' || paper.class === paperClass) && 
              (district === 'all' || paper.district === district)) {
            createPaperCard(paper, paperSnapshot.key);
          }
        });
        
        if (papersContainer.innerHTML === '') {
          papersContainer.innerHTML = `
            <div class="col-12 text-center py-5">
              <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
              <h5>No papers found</h5>
              <p class="text-muted">Try adjusting your filters</p>
            </div>
          `;
        }
      });
    }

    function createPaperCard(paper, paperId) {
      const col = document.createElement('div');
      col.className = 'col';
      
      const card = document.createElement('div');
      card.className = 'card h-100';
      
      // Paper thumbnail
      const thumbnail = document.createElement('div');
      thumbnail.className = 'paper-thumbnail';
      thumbnail.innerHTML = `<i class="fas fa-file-pdf"></i>`;
      
      // Card body
      const cardBody = document.createElement('div');
      cardBody.className = 'card-body';
      
      // Title and year badge
      const titleRow = document.createElement('div');
      titleRow.className = 'd-flex justify-content-between align-items-start mb-2';
      
      const title = document.createElement('h5');
      title.className = 'card-title mb-0';
      title.textContent = `Paper ${paper.paperNumber} - ${paper.title}`;
      
      const yearBadge = document.createElement('span');
      yearBadge.className = 'badge bg-primary';
      yearBadge.textContent = paper.year;
      
      titleRow.appendChild(title);
      titleRow.appendChild(yearBadge);
      
      // Class and district
      const details = document.createElement('p');
      details.className = 'card-text text-muted small mb-2';
      
      const districtBadge = document.createElement('span');
      districtBadge.className = `badge ${paper.district}-badge`;
      districtBadge.textContent = paper.district.charAt(0).toUpperCase() + paper.district.slice(1);
      
      details.innerHTML = `Class ${paper.class.split('class')[1]} | `;
      details.appendChild(districtBadge);
      
      // Available until
      const available = document.createElement('p');
      available.className = 'card-text small';
      available.textContent = `Available until: ${new Date(paper.availableUntil).toLocaleDateString()}`;
      
      // Time limit and action buttons
      const footer = document.createElement('div');
      footer.className = 'd-flex justify-content-between align-items-center mt-3';
      
      const timeBadge = document.createElement('span');
      timeBadge.className = 'badge bg-light text-dark';
      timeBadge.innerHTML = `<i class="fas fa-clock me-1"></i> ${paper.timeLimit} minutes`;
      
      const downloadBtn = document.createElement('button');
      downloadBtn.className = 'btn btn-sm btn-primary';
      downloadBtn.innerHTML = '<i class="fas fa-download me-1"></i> Download';
      downloadBtn.addEventListener('click', () => {
        window.open(paper.downloadUrl, '_blank');
      });
      
      footer.appendChild(timeBadge);
      
      // Add attend button if logged in
      if (auth.currentUser) {
        const attendBtn = document.createElement('button');
        attendBtn.className = 'btn btn-sm btn-success ms-2';
        attendBtn.innerHTML = '<i class="fas fa-pencil-alt me-1"></i> Attend';
        attendBtn.addEventListener('click', () => {
          openPaperModal(paper, paperId);
        });
        footer.appendChild(attendBtn);
      }
      
      footer.appendChild(downloadBtn);
      
      // Assemble card
      cardBody.appendChild(titleRow);
      cardBody.appendChild(details);
      cardBody.appendChild(available);
      cardBody.appendChild(footer);
      
      card.appendChild(thumbnail);
      card.appendChild(cardBody);
      col.appendChild(card);
      papersContainer.appendChild(col);
    }

    function openPaperModal(paper, paperId) {
      currentPaperId = paperId;
      document.getElementById('paperModalTitle').textContent = `Paper ${paper.paperNumber} - ${paper.title}`;
      paperViewer.src = paper.downloadUrl;
      
      // Start timer
      const endTime = Date.now() + (paper.timeLimit * 60000);
      updateTimer(endTime);
      examTimer = setInterval(() => updateTimer(endTime), 1000);
      
      submitPaperBtn.style.display = 'block';
      downloadAnswerBtn.style.display = 'none';
      paperModal.show();
    }

    function updateTimer(endTime) {
      const now = Date.now();
      const remaining = endTime - now;
      
      if (remaining <= 0) {
        clearInterval(examTimer);
        timerDisplay.innerHTML = '<span class="text-danger">Time\'s up!</span>';
        submitPaperBtn.style.display = 'none';
        downloadAnswerBtn.style.display = 'block';
        return;
      }
      
      const hours = Math.floor(remaining / (1000 * 60 * 60));
      const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
      
      timerDisplay.innerHTML = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Submit paper handler
    submitPaperBtn.addEventListener('click', () => {
      clearInterval(examTimer);
      alert('Your answers have been submitted successfully!');
      submitPaperBtn.style.display = 'none';
      downloadAnswerBtn.style.display = 'block';
      
      // In a real app, save submission to Firebase
      // database.ref('submissions/' + auth.currentUser.uid + '/' + currentPaperId).set({
      //   submittedAt: firebase.database.ServerValue.TIMESTAMP,
      //   status: 'submitted'
      // });
    });

    // Download answer sheet
    downloadAnswerBtn.addEventListener('click', () => {
      database.ref('papers/' + currentPaperId).once('value').then(snapshot => {
        const paper = snapshot.val();
        window.open(paper.answerSheetUrl, '_blank');
      });
    });

    // Load rankings
    function loadRankings() {
      const year = document.getElementById('rankYearFilter').value;
      const paperClass = document.getElementById('rankClassFilter').value;
      const paperNumber = document.getElementById('rankPaperFilter').value;
      const district = document.getElementById('rankDistrictFilter').value;
      
      let ref = database.ref(`rankings/${year}/${paperClass}/${paperNumber}`)
        .orderByChild('marks');
      
      if (district !== 'all') {
        ref = ref.orderByChild('district').equalTo(district);
      }
      
      ref.once('value').then(snapshot => {
        rankingsTable.innerHTML = '';
        const rankings = [];
        
        snapshot.forEach(childSnapshot => {
          rankings.push(childSnapshot.val());
        });
        
        // Sort by marks descending
        rankings.sort((a, b) => b.marks - a.marks);
        
        // Pagination
        const startIdx = (currentRankPage - 1) * ranksPerPage;
        const endIdx = startIdx + ranksPerPage;
        const paginatedRanks = rankings.slice(startIdx, endIdx);
        
        if (paginatedRanks.length === 0 && currentRankPage > 1) {
          currentRankPage--;
          loadRankings();
          return;
        }
        
        // Update pagination buttons
        document.getElementById('prevRankPage').disabled = currentRankPage <= 1;
        document.getElementById('nextRankPage').disabled = endIdx >= rankings.length;
        
        // Display rankings
        paginatedRanks.forEach((student, idx) => {
          const globalRank = startIdx + idx + 1;
          const row = document.createElement('tr');
          if (globalRank === 1) row.classList.add('rank-1');
          if (globalRank === 2) row.classList.add('rank-2');
          if (globalRank === 3) row.classList.add('rank-3');
          
          // Rank cell
          const rankCell = document.createElement('td');
          const rankBadge = document.createElement('span');
          rankBadge.className = `badge ${globalRank === 1 ? 'bg-warning text-dark' : 
                                globalRank === 2 ? 'bg-secondary' : 
                                globalRank === 3 ? 'bg-danger' : 'bg-light text-dark'}`;
          rankBadge.textContent = globalRank;
          rankCell.appendChild(rankBadge);
          
          // Name cell
          const nameCell = document.createElement('td');
          nameCell.textContent = student.name;
          
          // District cell
          const districtCell = document.createElement('td');
          const districtBadge = document.createElement('span');
          districtBadge.className = `badge ${student.district}-badge`;
          districtBadge.textContent = student.district.charAt(0).toUpperCase() + student.district.slice(1);
          districtCell.appendChild(districtBadge);
          
          // Marks cell
          const marksCell = document.createElement('td');
          marksCell.textContent = `${student.marks}%`;
          
          // Class cell
          const classCell = document.createElement('td');
          classCell.textContent = `Class ${paperClass.split('class')[1]}`;
          
          // Assemble row
          row.appendChild(rankCell);
          row.appendChild(nameCell);
          row.appendChild(districtCell);
          row.appendChild(marksCell);
          row.appendChild(classCell);
          
          rankingsTable.appendChild(row);
        });
      });
    }

    // Load personal rank
    function loadPersonalRank(uid) {
      const year = document.getElementById('rankYearFilter').value;
      const paperClass = document.getElementById('rankClassFilter').value;
      const paperNumber = document.getElementById('rankPaperFilter').value;
      
      database.ref(`rankings/${year}/${paperClass}/${paperNumber}`)
        .orderByChild('userId').equalTo(uid)
        .once('value').then(snapshot => {
          if (snapshot.exists()) {
            const studentData = Object.values(snapshot.val())[0];
            document.getElementById('userRank').textContent = `#${studentData.rank}`;
            document.getElementById('userDistrict').textContent = studentData.district.charAt(0).toUpperCase() + studentData.district.slice(1);
            document.getElementById('userMarks').textContent = `${studentData.marks}%`;
            document.getElementById('userPaperInfo').textContent = `Paper ${paperNumber} | Class ${paperClass.split('class')[1]} | ${year}`;
            
            // Update district badge class
            const districtBadge = document.getElementById('userDistrict');
            districtBadge.className = `badge ${studentData.district}-badge`;
          }
        });
    }

    // Filter event listeners
    ['paperYearFilter', 'paperClassFilter', 'paperDistrictFilter'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => {
        if (auth.currentUser) {
          loadStudentPapers(auth.currentUser.uid);
        } else {
          loadPublicPapers();
        }
      });
    });

    ['rankYearFilter', 'rankClassFilter', 'rankPaperFilter', 'rankDistrictFilter'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => {
        currentRankPage = 1;
        loadRankings();
        if (auth.currentUser) {
          loadPersonalRank(auth.currentUser.uid);
        }
      });
    });

    // Close modal handler
    paperModal._element.addEventListener('hidden.bs.modal', () => {
      clearInterval(examTimer);
      paperViewer.src = '';
    });
  </script>
  <script src="main.js"></script>
</body>
</html>