<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f9fa;
        overflow-x: hidden;
    }
    
    .sidebar {
        height: 100vh;
        background-color: #343a40;
        color: white;
        position: fixed;
        width: 250px;
        transition: all 0.3s;
        z-index: 1000;
    }
    
    .sidebar-header {
        padding: 20px;
        background-color: #23272b;
    }
    
    .sidebar-menu {
        padding: 20px 0;
        overflow-y: auto;
        height: calc(100vh - 70px);
    }
    
    .sidebar-menu a {
        color: #adb5bd;
        padding: 10px 20px;
        display: block;
        text-decoration: none;
        transition: all 0.3s;
    }
    
    .sidebar-menu a:hover, .sidebar-menu a.active {
        color: white;
        background-color: #495057;
    }
    
    .sidebar-menu i {
        margin-right: 10px;
    }
    
    .main-content {
        margin-left: 250px;
        padding: 20px;
        transition: all 0.3s;
    }
    
    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
    }
    
    .card-header {
        background-color: white;
        border-bottom: 1px solid #e9ecef;
        font-weight: 600;
    }
    
    .table th {
        border-top: none;
        font-weight: 600;
        color: #495057;
    }
    
    .nav-tabs .nav-link.active {
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #343a40;
    }
    
    .btn-primary {
        background-color: #343a40;
        border: none;
    }
    
    .btn-primary:hover {
        background-color: #23272b;
    }
    
    .logout-btn {
        color: #dc3545;
        background: none;
        border: none;
    }
    
    .logout-btn:hover {
        color: #c82333;
    }
    
    .copy-link {
        cursor: pointer;
    }
    
    .copy-link:hover {
        color: #0d6efd;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        vertical-align: middle;
        border: 0.2em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border .75s linear infinite;
    }
    
    @keyframes spinner-border {
        to { transform: rotate(360deg); }
    }
    
    .time-remaining {
        font-size: 1.2rem;
        font-weight: bold;
        color: #28a745;
    }
    
    .access-paper-btn {
        transition: all 0.2s ease;
    }
    
    .access-paper-btn:hover {
        transform: scale(1.05);
    }
    
    #createPaperForm[data-processing="true"] {
        opacity: 0.7;
        pointer-events: none;
    }
    
    .spinner-border {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        vertical-align: text-top;
        border: 0.2em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border .75s linear infinite;
    }
    
    /* Responsive styles */
    @media (max-width: 992px) {
        .sidebar {
            width: 220px;
        }
        
        .main-content {
            margin-left: 220px;
        }
        
        .card-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .card-header input {
            width: 100% !important;
            margin-top: 10px;
        }
    }
    
    @media (max-width: 768px) {
        .sidebar {
            width: 100%;
            height: auto;
            position: relative;
        }
        
        .sidebar-menu {
            height: auto;
            max-height: 300px;
        }
        
        .main-content {
            margin-left: 0;
            padding: 15px;
        }
        
        .row {
            flex-direction: column;
        }
        
        .col-md-4, .col-md-6, .col-md-8, .col-md-3, .col-md-2 {
            width: 100%;
            margin-bottom: 15px;
        }
        
        .btn-group {
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .btn-group .btn {
            margin-bottom: 5px;
        }
        
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-dialog {
            margin: 10px;
        }
        
        .question-item .row {
            flex-direction: column;
        }
        
        .question-item .col-md-8, 
        .question-item .col-md-2 {
            width: 100%;
            margin-bottom: 10px;
        }
    }
    
    @media (max-width: 576px) {
        .d-flex.justify-content-between {
            flex-direction: column;
        }
        
        .input-group.w-25 {
            width: 100% !important;
            margin-top: 10px;
        }
        
        .modal-dialog.modal-lg {
            max-width: 95%;
        }
        
        .card-header .d-flex {
            flex-direction: column;
        }
        
        .card-header .btn {
            margin-top: 10px;
            width: 100%;
        }
        
        .table th, .table td {
            padding: 0.5rem;
            font-size: 0.9rem;
        }
        
        .btn {
            white-space: nowrap;
            font-size: 0.9rem;
        }
    }
    
    @media (max-width: 400px) {
        .sidebar-menu a {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .main-content {
            padding: 10px;
        }
        
        h3 {
            font-size: 1.3rem;
        }
        
        .btn-group .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
    }
</style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h4>Paper Class Admin</h4>
        </div>
        <div class="sidebar-menu">
            <a href="#" class="active" id="dashboardTab"><i class="bi bi-speedometer2"></i> Dashboard</a>
            <a href="#" id="createPaperTab"><i class="bi bi-file-earmark-plus"></i> Create Paper</a>
            <a href="#" id="viewPapersTab"><i class="bi bi-collection"></i> View Papers</a>
            <a href="#" id="viewSubmissionsTab"><i class="bi bi-list-check"></i> View Submissions</a>
            <a href="#" id="viewRankingsTab"><i class="bi bi-trophy"></i> View Rankings</a>
            <div class="mt-4 px-3">
                <button class="logout-btn" id="logoutBtn"><i class="bi bi-box-arrow-left"></i> Logout</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboardSection">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Dashboard Overview</h3>
                <div class="text-muted" id="currentDate"></div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted">Total Papers</h6>
                                    <h3 id="totalPapers">0</h3>
                                </div>
                                <div class="bg-light p-3 rounded">
                                    <i class="bi bi-collection text-primary" style="font-size: 1.5rem;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted">Total Submissions</h6>
                                    <h3 id="totalSubmissions">0</h3>
                                </div>
                                <div class="bg-light p-3 rounded">
                                    <i class="bi bi-list-check text-success" style="font-size: 1.5rem;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted">Active Papers</h6>
                                    <h3 id="activePapers">0</h3>
                                </div>
                                <div class="bg-light p-3 rounded">
                                    <i class="bi bi-hourglass-split text-warning" style="font-size: 1.5rem;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    Recent Submissions
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Paper</th>
                                    <th>Student</th>
                                    <th>NIC</th>
                                    <th>Score</th>
                                    <th>Rank</th>
                                    <th>Submitted At</th>
                                </tr>
                            </thead>
                            <tbody id="recentSubmissions">
                                <!-- Recent submissions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Paper Section -->
        <div id="createPaperSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Create New Paper</h3>
            </div>

            <div class="card">
                <div class="card-header">
                    Paper Details
                </div>
                <div class="card-body">
                    <form id="createPaperForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="paperTitle" class="form-label">Paper Title*</label>
                                <input type="text" class="form-control" id="paperTitle" required>
                            </div>
                            <div class="col-md-3">
                                <label for="paperYear" class="form-label">Year*</label>
                                <input type="number" class="form-control" id="paperYear" required>
                            </div>
                            <div class="col-md-3">
                                <label for="paperNumber" class="form-label">Paper Number*</label>
                                <input type="number" class="form-control" id="paperNumber" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="paperSubject" class="form-label">Subject*</label>
                                <input type="text" class="form-control" id="paperSubject" required>
                            </div>
                            <div class="col-md-6">
                                <label for="paperMedium" class="form-label">Medium*</label>
                                <select class="form-select" id="paperMedium" required>
                                    <option value="">Select Medium</option>
                                    <option value="Sinhala">Sinhala</option>
                                    <option value="English">English</option>
                                    <option value="Tamil">Tamil</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="openTime" class="form-label">Open Date & Time*</label>
                                <input type="datetime-local" class="form-control" id="openTime" required>
                            </div>
                            <div class="col-md-6">
                                <label for="closeTime" class="form-label">Close Date & Time*</label>
                                <input type="datetime-local" class="form-control" id="closeTime" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="paperPdf" class="form-label">Upload Paper PDF*</label>
                            <input type="file" class="form-control" id="paperPdf" accept=".pdf" required>
                        </div>

                        <div class="mb-3">
                            <label for="answerKeyPdf" class="form-label">Upload Answer Key PDF*</label>
                            <input type="file" class="form-control" id="answerKeyPdf" accept=".pdf" required>
                        </div>

                        <div class="mb-4">
                            <h5 class="border-bottom pb-2">Questions & Answers</h5>
                            <div id="questionsContainer">
                                <div class="question-item mb-3 p-3 border rounded">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label class="form-label">Question 1</label>
                                            <input type="text" class="form-control question-text" placeholder="Question text">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Marks</label>
                                            <input type="number" class="form-control question-marks" placeholder="Marks">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Answer</label>
                                            <input type="text" class="form-control question-answer" placeholder="Answer">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary mt-2" id="addQuestionBtn">
                                <i class="bi bi-plus-circle"></i> Add Question
                            </button>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="createPaperBtn">
                                <span id="createPaperBtnText">Create Paper</span>
                                <span id="createPaperSpinner" class="loading-spinner" style="display: none;"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- View Papers Section -->
        <div id="viewPapersSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>All Papers</h3>
                <div class="btn-group">
                    <button class="btn btn-outline-secondary active" id="allPapersBtn">All</button>
                    <button class="btn btn-outline-secondary" id="activePapersBtn">Active</button>
                    <button class="btn btn-outline-secondary" id="upcomingPapersBtn">Upcoming</button>
                    <button class="btn btn-outline-secondary" id="closedPapersBtn">Closed</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Papers List</span>
                        <input type="text" class="form-control w-25" id="paperSearch" placeholder="Search papers...">
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Year</th>
                                    <th>Paper No.</th>
                                    <th>Subject</th>
                                    <th>Status</th>
                                    <th>Submissions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="papersList">
                                <!-- Papers will be loaded here -->
                                <tr id="papersLoading">
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Submissions Section -->
        <div id="viewSubmissionsSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Paper Submissions</h3>
                <div class="input-group w-25">
                    <select class="form-select" id="submissionPaperFilter">
                        <option value="">All Papers</option>
                        <!-- Papers will be loaded here -->
                    </select>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Submissions List</span>
                        <input type="text" class="form-control w-25" id="submissionSearch" placeholder="Search submissions...">
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Paper</th>
                                    <th>Student</th>
                                    <th>NIC</th>
                                    <th>District</th>
                                    <th>Class</th>
                                    <th>Score</th>
                                    <th>Submitted At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="submissionsList">
                                <!-- Submissions will be loaded here -->
                                <tr id="submissionsLoading">
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Rankings Section -->
        <div id="viewRankingsSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Paper Rankings</h3>
                <div class="input-group w-25">
                    <select class="form-select" id="rankingPaperFilter">
                        <option value="">Select Paper</option>
                        <!-- Papers will be loaded here -->
                    </select>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Rankings</span>
                        <div>
                            <button class="btn btn-outline-secondary" id="exportRankingsBtn">
                                <i class="bi bi-download"></i> Export
                            </button>
                            <button class="btn btn-outline-primary ms-2" id="classRankingsBtn">
                                <i class="bi bi-people"></i> Class Rankings
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Student</th>
                                    <th>NIC</th>
                                    <th>District</th>
                                    <th>Class</th>
                                    <th>School</th>
                                    <th>Score</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody id="rankingsList">
                                <!-- Rankings will be loaded here -->
                                <tr id="rankingsLoading">
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Submission Details -->
    <div class="modal fade" id="submissionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Submission Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="submissionDetails">
                    <!-- Submission details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Paper Details -->
    <div class="modal fade" id="paperModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Paper Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="paperDetails">
                    <!-- Paper details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="copyPaperLinkBtn">
                        <i class="bi bi-link-45deg"></i> Copy Paper Link
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Class Rankings -->
    <div class="modal fade" id="classRankingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Class Rankings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="classRankingsContent">
                    <!-- Class rankings will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="exportClassRankingsBtn">
                        <i class="bi bi-download"></i> Export All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyD5SRZWB-QwMg7wmyTjcvHZqP-mEdlll_M",
    authDomain: "paper-class-1ab19.firebaseapp.com",
    databaseURL: "https://paper-class-1ab19-default-rtdb.firebaseio.com",
    projectId: "paper-class-1ab19",
    storageBucket: "paper-class-1ab19.firebasestorage.app",
    messagingSenderId: "83634677566",
    appId: "1:83634677566:web:fb4f7a1fd869c3e82e2e6f"
  };

// Initialize Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth();
const database = firebase.database();
const storage = firebase.storage();


function checkPaperAvailability(paperId) {
    return database.ref(`papers/${paperId}`).once('value').then(snapshot => {
        const paper = snapshot.val();
        if (!paper) return false;
        
        const now = new Date().getTime();
        const openTime = new Date(paper.openTime).getTime();
        const closeTime = new Date(paper.closeTime).getTime();
        
        return now >= openTime && now <= closeTime;
    });
}


// DOM elements
const sections = {
    dashboard: document.getElementById('dashboardSection'),
    createPaper: document.getElementById('createPaperSection'),
    viewPapers: document.getElementById('viewPapersSection'),
    viewSubmissions: document.getElementById('viewSubmissionsSection'),
    viewRankings: document.getElementById('viewRankingsSection')
};

// Tab navigation
document.getElementById('dashboardTab').addEventListener('click', () => showSection('dashboard'));
document.getElementById('createPaperTab').addEventListener('click', () => showSection('createPaper'));
document.getElementById('viewPapersTab').addEventListener('click', () => {
    showSection('viewPapers');
    loadPapers();
});
document.getElementById('viewSubmissionsTab').addEventListener('click', () => {
    showSection('viewSubmissions');
    loadSubmissions();
});
document.getElementById('viewRankingsTab').addEventListener('click', () => {
    showSection('viewRankings');
    loadPapersForRankings();
});

// Logout
document.getElementById('logoutBtn').addEventListener('click', () => {
    auth.signOut().then(() => {
        window.location.href = 'admin-login.html';
    });
});

// Show section function
function showSection(section) {
    Object.values(sections).forEach(sec => sec.style.display = 'none');
    sections[section].style.display = 'block';
    document.querySelectorAll('.sidebar-menu a').forEach(tab => tab.classList.remove('active'));
    document.getElementById(`${section}Tab`).classList.add('active');
}

// Set current date
document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});

// Initialize dashboard
function initDashboard() {
    // Load counts
    database.ref('papers').once('value').then(snapshot => {
        const papers = snapshot.val() || {};
        document.getElementById('totalPapers').textContent = Object.keys(papers).length;
        
        const now = new Date().getTime();
        const activePapers = Object.values(papers).filter(paper => {
            return now >= new Date(paper.openTime).getTime() && 
                   now <= new Date(paper.closeTime).getTime();
        });
        document.getElementById('activePapers').textContent = activePapers.length;
    });

    // Load total submissions
    database.ref('submissions').once('value').then(snapshot => {
        const submissions = snapshot.val() || {};
        let total = 0;
        Object.values(submissions).forEach(paper => {
            total += Object.keys(paper).length;
        });
        document.getElementById('totalSubmissions').textContent = total;
    });

    // Load recent submissions
    database.ref('submissions').once('value').then(snapshot => {
        const submissionsData = snapshot.val() || {};
        const recentSubmissions = [];
        
        for (const [paperId, paperSubmissions] of Object.entries(submissionsData)) {
            for (const [nic, submission] of Object.entries(paperSubmissions)) {
                recentSubmissions.push({ paperId, nic, ...submission });
            }
        }
        
        recentSubmissions.sort((a, b) => b.timestamp - a.timestamp);
        
        const tbody = document.getElementById('recentSubmissions');
        tbody.innerHTML = '';
        
        recentSubmissions.slice(0, 5).forEach(sub => {
            database.ref(`papers/${sub.paperId}/title`).once('value').then(paperSnapshot => {
                const paperTitle = paperSnapshot.val() || 'Unknown Paper';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${paperTitle}</td>
                    <td>${sub.name}</td>
                    <td>${sub.nic}</td>
                    <td>${sub.score}</td>
                    <td>${sub.rank || '-'}</td>
                    <td>${new Date(sub.timestamp).toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
        });
    });
}

// Paper creation functionality
let questionCount = 1;
let isProcessingForm = false;

document.getElementById('addQuestionBtn').addEventListener('click', () => {
    questionCount++;
    const container = document.getElementById('questionsContainer');
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question-item mb-3 p-3 border rounded';
    questionDiv.innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <label class="form-label">Question ${questionCount}</label>
                <input type="text" class="form-control question-text" placeholder="Question text">
            </div>
            <div class="col-md-2">
                <label class="form-label">Marks</label>
                <input type="number" class="form-control question-marks" placeholder="Marks">
            </div>
            <div class="col-md-2">
                <label class="form-label">Answer</label>
                <input type="text" class="form-control question-answer" placeholder="Answer">
            </div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger mt-2 remove-question">
            <i class="bi bi-trash"></i> Remove
        </button>
    `;
    container.appendChild(questionDiv);
});

// Remove question event delegation
document.getElementById('questionsContainer').addEventListener('click', (e) => {
    if (e.target.classList.contains('remove-question') || e.target.closest('.remove-question')) {
        e.target.closest('.question-item').remove();
        questionCount--;
        const questions = document.querySelectorAll('.question-item');
        questions.forEach((q, index) => {
            q.querySelector('.form-label').textContent = `Question ${index + 1}`;
        });
    }
});

// Handle paper creation form
document.getElementById('createPaperForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (isProcessingForm) return;
    isProcessingForm = true;
    
    try {
        const createPaperBtn = document.getElementById('createPaperBtn');
        createPaperBtn.disabled = true;
        createPaperBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';

        const title = document.getElementById('paperTitle').value.trim();
        const year = document.getElementById('paperYear').value.trim();
        const paperNumber = document.getElementById('paperNumber').value.trim();
        const subject = document.getElementById('paperSubject').value.trim();
        const medium = document.getElementById('paperMedium').value;
        const openTime = document.getElementById('openTime').value;
        const closeTime = document.getElementById('closeTime').value;
        const pdfFile = document.getElementById('paperPdf').files[0];
        const answerKeyFile = document.getElementById('answerKeyPdf').files[0];
        
        // Validate inputs
        if (!title || !year || !paperNumber || !subject || !medium || !openTime || !closeTime) {
            throw new Error('Please fill in all required fields');
        }

        // Get questions
        const questions = {};
        const questionItems = document.querySelectorAll('.question-item');
        let totalMarks = 0;
        
        questionItems.forEach((item, index) => {
            const text = item.querySelector('.question-text').value.trim();
            const marks = parseInt(item.querySelector('.question-marks').value) || 0;
            const answer = item.querySelector('.question-answer').value.trim().toUpperCase();
            
            if (text && !isNaN(marks) && answer) {
                questions[index + 1] = {
                    questionText: text,
                    marks: marks,
                    answer: answer
                };
                totalMarks += marks;
            }
        });
        
        if (Object.keys(questions).length === 0) {
            throw new Error('Please add at least one valid question');
        }
        
        if (!pdfFile || !answerKeyFile) {
            throw new Error('Please upload both the paper PDF and answer key PDF');
        }
// Add date validation
        const openDate = new Date(openTime);
        const closeDate = new Date(closeTime);
        const now = new Date();
        
        if (openDate < now) {
            throw new Error('Open time cannot be in the past');
        }
        
        if (closeDate <= openDate) {
            throw new Error('Close time must be after open time');
        }
        
        if ((closeDate - openDate) < (30 * 60 * 1000)) { // 30 minutes minimum
            throw new Error('The paper should be available for at least 30 minutes');
        }
        // Generate paper ID
        const paperId = `${title.replace(/\s+/g, '-').toLowerCase()}-${year}-${Date.now()}`;
        
        // Upload files to storage
        const storageRef = storage.ref();
        const pdfTask = storageRef.child(`papers/${paperId}/paper.pdf`).put(pdfFile);
        const answerTask = storageRef.child(`papers/${paperId}/answers.pdf`).put(answerKeyFile);
        
        await Promise.all([pdfTask, answerTask]);
        
        // Get download URLs
        const [pdfUrl, answerKeyUrl] = await Promise.all([
            storageRef.child(`papers/${paperId}/paper.pdf`).getDownloadURL(),
            storageRef.child(`papers/${paperId}/answers.pdf`).getDownloadURL()
        ]);

        // Save paper data
        await database.ref(`papers/${paperId}`).set({
            title,
            year,
            paperNumber,
            subject,
            medium,
            openTime: new Date(openTime).toISOString(),
            closeTime: new Date(closeTime).toISOString(),
            pdfUrl,
            answerKeyUrl,
            questions,
            totalMarks,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        });

        alert('Paper created successfully!');
        document.getElementById('createPaperForm').reset();
        document.getElementById('questionsContainer').innerHTML = `
            <div class="question-item mb-3 p-3 border rounded">
                <div class="row">
                    <div class="col-md-8">
                        <label class="form-label">Question 1</label>
                        <input type="text" class="form-control question-text" placeholder="Question text">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Marks</label>
                        <input type="number" class="form-control question-marks" placeholder="Marks">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Answer</label>
                        <input type="text" class="form-control question-answer" placeholder="Answer">
                    </div>
                </div>
            </div>
        `;
        questionCount = 1;

    } catch (error) {
        console.error('Error creating paper:', error);
        alert(`Error: ${error.message}`);
    } finally {
        isProcessingForm = false;
        const createPaperBtn = document.getElementById('createPaperBtn');
        createPaperBtn.disabled = false;
        createPaperBtn.textContent = 'Create Paper';
    }
});

// Load papers for viewing
async function loadPapers(filter = 'all') {
    const tbody = document.getElementById('papersList');
    tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border text-primary"></div></td></tr>';
    
    try {
        const snapshot = await database.ref('papers').once('value');
        const papers = snapshot.val() || {};
        const now = new Date().getTime();
        tbody.innerHTML = '';
        
        const papersArray = await Promise.all(
            Object.entries(papers).map(async ([id, paper]) => {
                const openTime = new Date(paper.openTime).getTime();
                const closeTime = new Date(paper.closeTime).getTime();
                const isActive = now >= openTime && now <= closeTime;
                
                return {
                    id,
                    ...paper,
                    openTime,
                    closeTime,
                    isActive
                };
            })
        );
        
        const filteredPapers = papersArray.filter(paper => {
            if (filter === 'all') return true;
            if (filter === 'active') return paper.isActive;
            if (filter === 'upcoming') return now < paper.openTime;
            if (filter === 'closed') return now > paper.closeTime;
            return true;
        });
        
        if (filteredPapers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No papers found</td></tr>';
            return;
        }
        
        const submissionCounts = await Promise.all(
            filteredPapers.map(paper => 
                database.ref(`submissions/${paper.id}`).once('value')
            )
        );
        
        filteredPapers.forEach((paper, index) => {
            const submissions = submissionCounts[index].val() || {};
            const submissionCount = Object.keys(submissions).length;
            
            let statusBadge = '';
            if (paper.isActive) {
                statusBadge = '<span class="badge bg-success">Active</span>';
            } else if (now < paper.openTime) {
                statusBadge = '<span class="badge bg-warning">Upcoming</span>';
            } else {
                statusBadge = '<span class="badge bg-secondary">Closed</span>';
            }
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${paper.title}</td>
                <td>${paper.year}</td>
                <td>${paper.paperNumber}</td>
                <td>${paper.subject}</td>
                <td>${statusBadge}</td>
                <td>${submissionCount}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-paper-btn" data-id="${paper.id}">
                        <i class="bi bi-eye"></i> View
                    </button>
                    ${paper.isActive ? `
                    <button class="btn btn-sm btn-outline-success ms-1 access-paper-btn" data-id="${paper.id}">
                        <i class="bi bi-box-arrow-in-right"></i> Access
                    </button>
                    ` : ''}
                </td>
            `;
            tbody.appendChild(row);
            
            row.querySelector('.view-paper-btn').addEventListener('click', () => viewPaperDetails(paper.id));
            if (paper.isActive) {
                row.querySelector('.access-paper-btn').addEventListener('click', () => {
                    window.location.href = `student-paper.html?paperId=${paper.id}`;
                });
            }
        });
        
    } catch (error) {
        console.error('Error loading papers:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading papers</td></tr>';
    }
}

// View paper details
async function viewPaperDetails(paperId) {
    try {
        const [paperSnapshot, isAvailable] = await Promise.all([
            database.ref(`papers/${paperId}`).once('value'),
            checkPaperAvailability(paperId)
        ]);
        
        const paper = paperSnapshot.val();
        if (!paper) throw new Error('Paper not found');

        const openTime = new Date(paper.openTime);
        const closeTime = new Date(paper.closeTime);
        const now = new Date();
        let status = now < openTime ? 'Upcoming' : now > closeTime ? 'Closed' : 'Active';

        let html = `
            <div class="row mb-4">
                <div class="col-md-8">
                    <h4>${paper.title}</h4>
                    <p class="mb-1"><strong>Status:</strong> 
                        <span class="badge ${status === 'Active' ? 'bg-success' : status === 'Upcoming' ? 'bg-warning' : 'bg-secondary'}">
                            ${status}
                        </span>
                    </p>
                    <p class="mb-1"><strong>Available:</strong> ${openTime.toLocaleString()} to ${closeTime.toLocaleString()}</p>
        `;

        if (status !== 'Active') {
            html += `
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle"></i> This paper is not currently available for access.
                    ${status === 'Upcoming' ? 'It will become available at the specified open time.' : 'The submission period has ended.'}
                </div>
            `;
        }

        html += `
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Time Remaining</h6>
                            <div id="timeRemaining"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Only show access buttons if paper is active
        if (status === 'Active') {
            html += `
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0">Paper PDF</h5></div>
                        <div class="card-body text-center">
                            <a href="${paper.pdfUrl}" target="_blank" class="btn btn-primary">
                                <i class="bi bi-download"></i> Download Paper
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0">Answer Key</h5></div>
                        <div class="card-body text-center">
                            <a href="${paper.answerKeyUrl}" target="_blank" class="btn btn-primary">
                                <i class="bi bi-download"></i> Download Answer Key
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        html += `
            <div class="mt-4">
                <h5>Paper Details</h5>
                <table class="table table-bordered">
                    <tr><th>Year</th><td>${paper.year}</td></tr>
                    <tr><th>Paper Number</th><td>${paper.paperNumber}</td></tr>
                    <tr><th>Subject</th><td>${paper.subject}</td></tr>
                    <tr><th>Medium</th><td>${paper.medium}</td></tr>
                    <tr><th>Total Marks</th><td>${paper.totalMarks}</td></tr>
                </table>
            </div>
        `;

        document.getElementById('paperDetails').innerHTML = html;
        
        // Update time remaining counter if paper is active
        if (status === 'Active') {
            updateTimeRemaining(closeTime);
            const timer = setInterval(() => updateTimeRemaining(closeTime), 1000);
            
            // Clear interval when modal is closed
            document.getElementById('paperModal').addEventListener('hidden.bs.modal', () => {
                clearInterval(timer);
            });
        }

        const modal = new bootstrap.Modal(document.getElementById('paperModal'));
        modal.show();

    } catch (error) {
        console.error('Error viewing paper:', error);
        alert(`Error: ${error.message}`);
    }
}

function updateTimeRemaining(closeTime) {
    const now = new Date();
    const end = new Date(closeTime);
    const diff = end - now;
    
    if (diff <= 0) {
        document.getElementById('timeRemaining').innerHTML = 'Time expired';
        return;
    }
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    document.getElementById('timeRemaining').innerHTML = `
        ${hours}h ${minutes}m ${seconds}s remaining
    `;
}


// Copy paper link
function copyPaperLink(paperId) {
    const paperLink = `${window.location.origin}/student-paper.html?paperId=${paperId}`;
    navigator.clipboard.writeText(paperLink).then(() => {
        alert('Paper link copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy link:', err);
        alert('Failed to copy link. Please try again.');
    });
}

// Load submissions
async function loadSubmissions(paperId = '') {
    const tbody = document.getElementById('submissionsList');
    tbody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner-border text-primary"></div></td></tr>';
    
    try {
        let query = paperId ? database.ref(`submissions/${paperId}`) : database.ref('submissions');
        const snapshot = await query.once('value');
        const submissionsData = snapshot.val() || {};
        const submissions = [];
        
        if (paperId) {
            for (const [nic, submission] of Object.entries(submissionsData)) {
                submissions.push({ paperId, nic, ...submission });
            }
        } else {
            for (const [paperId, paperSubmissions] of Object.entries(submissionsData)) {
                for (const [nic, submission] of Object.entries(paperSubmissions)) {
                    submissions.push({ paperId, nic, ...submission });
                }
            }
        }
        
        tbody.innerHTML = '';
        if (submissions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">No submissions found</td></tr>';
            return;
        }
        
        const paperTitles = await Promise.all(
            submissions.map(sub => 
                database.ref(`papers/${sub.paperId}/title`).once('value')
        ));
        
        submissions.forEach((sub, index) => {
            const paperTitle = paperTitles[index].val() || 'Unknown Paper';
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${paperTitle}</td>
                <td>${sub.name}</td>
                <td>${sub.nic}</td>
                <td>${sub.district}</td>
                <td>${sub.class}</td>
                <td>${sub.score}</td>
                <td>${new Date(sub.timestamp).toLocaleString()}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-submission" data-paper="${sub.paperId}" data-nic="${sub.nic}">
                        <i class="bi bi-eye"></i> View
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            row.querySelector('.view-submission').addEventListener('click', () => viewSubmissionDetails(sub.paperId, sub.nic));
        });
        
        if (!paperId) {
            const papersSnapshot = await database.ref('papers').once('value');
            const papers = papersSnapshot.val() || {};
            const select = document.getElementById('submissionPaperFilter');
            select.innerHTML = '<option value="">All Papers</option>';
            
            Object.entries(papers).forEach(([id, paper]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${paper.title} (${paper.year})`;
                select.appendChild(option);
            });
            
            select.addEventListener('change', () => loadSubmissions(select.value));
        }

    } catch (error) {
        console.error('Error loading submissions:', error);
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading submissions</td></tr>';
    }
}

// View submission details
async function viewSubmissionDetails(paperId, nic) {
    try {
        const [paperSnapshot, submissionSnapshot] = await Promise.all([
            database.ref(`papers/${paperId}`).once('value'),
            database.ref(`submissions/${paperId}/${nic}`).once('value')
        ]);
        
        const paper = paperSnapshot.val();
        const submission = submissionSnapshot.val();
        
        if (!paper || !submission) throw new Error('Submission details not found');
        
        let html = `
            <div class="row mb-4">
                <div class="col-md-6">
                    <h6>Paper: ${paper.title}</h6>
                    <h6>Student: ${submission.name} (${nic})</h6>
                </div>
                <div class="col-md-6 text-end">
                    <h5>Score: ${submission.score} / ${paper.totalMarks}</h5>
                    <h6>Submitted: ${new Date(submission.timestamp).toLocaleString()}</h6>
                </div>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Question</th>
                        <th>Correct Answer</th>
                        <th>Student's Answer</th>
                        <th>Marks</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        for (const [qNum, question] of Object.entries(paper.questions)) {
            const studentAnswer = submission.answers[qNum] || '-';
            const isCorrect = studentAnswer === question.answer;
            const marksEarned = isCorrect ? question.marks : 0;
            
            html += `
                <tr>
                    <td>${question.questionText}</td>
                    <td>${question.answer}</td>
                    <td>${studentAnswer}</td>
                    <td>${question.marks}</td>
                    <td class="${isCorrect ? 'text-success' : 'text-danger'}">
                        ${isCorrect ? 'Correct' : 'Incorrect'} (${marksEarned}/${question.marks})
                    </td>
                </tr>
            `;
        }
        
        html += `</tbody></table>`;
        document.getElementById('submissionDetails').innerHTML = html;
        new bootstrap.Modal(document.getElementById('submissionModal')).show();

    } catch (error) {
        console.error('Error viewing submission:', error);
        alert(`Error: ${error.message}`);
    }
}

// Load papers for rankings
async function loadPapersForRankings() {
    try {
        const snapshot = await database.ref('papers').once('value');
        const papers = snapshot.val() || {};
        const select = document.getElementById('rankingPaperFilter');
        select.innerHTML = '<option value="">Select Paper</option>';
        
        Object.entries(papers).forEach(([id, paper]) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = `${paper.title} (${paper.year})`;
            select.appendChild(option);
        });
        
        select.addEventListener('change', () => {
            if (select.value) loadRankings(select.value);
            else document.getElementById('rankingsList').innerHTML = '';
        });

    } catch (error) {
        console.error('Error loading papers for rankings:', error);
    }
}

// Load rankings for a paper
async function loadRankings(paperId) {
    const tbody = document.getElementById('rankingsList');
    tbody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner-border text-primary"></div></td></tr>';
    
    try {
        const [paperSnapshot, submissionsSnapshot] = await Promise.all([
            database.ref(`papers/${paperId}`).once('value'),
            database.ref(`submissions/${paperId}`).once('value')
        ]);
        
        const paper = paperSnapshot.val();
        const submissions = submissionsSnapshot.val() || {};
        
        if (!paper) throw new Error('Paper not found');
        
        const submissionsArray = Object.entries(submissions).map(([nic, submission]) => ({
            nic, ...submission
        }));
        
        submissionsArray.sort((a, b) => b.score - a.score);
        
        let currentRank = 1;
        submissionsArray.forEach((sub, index) => {
            if (index > 0 && sub.score < submissionsArray[index - 1].score) {
                currentRank = index + 1;
            }
            sub.rank = currentRank;
        });
        
        tbody.innerHTML = '';
        if (submissionsArray.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">No submissions found</td></tr>';
            return;
        }
        
        submissionsArray.forEach(sub => {
            const percentage = ((sub.score / paper.totalMarks) * 100).toFixed(1);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${sub.rank}</td>
                <td>${sub.name}</td>
                <td>${sub.nic}</td>
                <td>${sub.district}</td>
                <td>${sub.class}</td>
                <td>${sub.school || '-'}</td>
                <td>${sub.score}</td>
                <td>${percentage}%</td>
            `;
            tbody.appendChild(row);
        });
        
        const updates = {};
        submissionsArray.forEach(sub => {
            updates[`submissions/${paperId}/${sub.nic}/rank`] = sub.rank;
        });
        await database.ref().update(updates);

    } catch (error) {
        console.error('Error loading rankings:', error);
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading rankings</td></tr>';
    }
}

// Export rankings
document.getElementById('exportRankingsBtn').addEventListener('click', () => {
    const paperId = document.getElementById('rankingPaperFilter').value;
    if (!paperId) {
        alert('Please select a paper first');
        return;
    }
    
    let csvContent = "Rank,Name,NIC,District,Class,School,Score,Percentage\n";
    document.querySelectorAll('#rankingsList tr').forEach(row => {
        const cells = row.querySelectorAll('td');
        csvContent += Array.from(cells).map(cell => `"${cell.textContent}"`).join(',') + '\n';
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `rankings-${paperId}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});

// Class rankings
document.getElementById('classRankingsBtn').addEventListener('click', async () => {
    const paperId = document.getElementById('rankingPaperFilter').value;
    if (!paperId) {
        alert('Please select a paper first');
        return;
    }
    
    try {
        const [paperSnapshot, submissionsSnapshot] = await Promise.all([
            database.ref(`papers/${paperId}`).once('value'),
            database.ref(`submissions/${paperId}`).once('value')
        ]);
        
        const paper = paperSnapshot.val();
        const submissions = submissionsSnapshot.val() || {};
        
        if (!paper) throw new Error('Paper not found');
        
        const submissionsArray = Object.entries(submissions).map(([nic, submission]) => ({
            nic, ...submission
        }));
        
        const classGroups = {};
        submissionsArray.forEach(sub => {
            if (!classGroups[sub.class]) classGroups[sub.class] = [];
            classGroups[sub.class].push(sub);
        });
        
        for (const [classGroup, students] of Object.entries(classGroups)) {
            students.sort((a, b) => b.score - a.score);
            let currentRank = 1;
            students.forEach((student, index) => {
                if (index > 0 && student.score < students[index - 1].score) {
                    currentRank = index + 1;
                }
                student.classRank = currentRank;
            });
        }
        
        let html = '';
        for (const [classGroup, students] of Object.entries(classGroups)) {
            html += `
                <div class="mb-5">
                    <h4>Class ${classGroup}</h4>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Student</th>
                                    <th>NIC</th>
                                    <th>District</th>
                                    <th>School</th>
                                    <th>Score</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            students.forEach(student => {
                const percentage = ((student.score / paper.totalMarks) * 100).toFixed(1);
                html += `
                    <tr>
                        <td>${student.classRank}</td>
                        <td>${student.name}</td>
                        <td>${student.nic}</td>
                        <td>${student.district}</td>
                        <td>${student.school || '-'}</td>
                        <td>${student.score}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table></div></div>`;
        }
        
        document.getElementById('classRankingsContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('classRankingsModal')).show();
        
        document.getElementById('exportClassRankingsBtn').onclick = () => {
            let csvContent = '';
            for (const [classGroup, students] of Object.entries(classGroups)) {
                csvContent += `Class ${classGroup}\nRank,Name,NIC,District,School,Score,Percentage\n`;
                students.forEach(student => {
                    const percentage = ((student.score / paper.totalMarks) * 100).toFixed(1);
                    csvContent += `${student.classRank},"${student.name}","${student.nic}","${student.district}","${student.school || '-'}",${student.score},${percentage}\n`;
                });
                csvContent += "\n";
            }
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `class-rankings-${paperId}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

    } catch (error) {
        console.error('Error loading class rankings:', error);
        alert(`Error: ${error.message}`);
    }
});

// Check authentication on load
auth.onAuthStateChanged((user) => {
    if (user) {
        database.ref('admins/' + user.uid).once('value').then((snapshot) => {
            if (snapshot.exists()) {
                initDashboard();
            } else {
                auth.signOut();
                window.location.href = 'admin-login.html';
            }
        });
    } else {
        window.location.href = 'admin-login.html';
    }
});
</script>

<script src="main.js"></script>
</body>
</html>